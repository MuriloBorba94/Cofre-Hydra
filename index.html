
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydra Finances - Metrópole HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0a0a0a; 
            color: #f3f4f6;
            background-image: radial-gradient(circle at center, #25001a 0%, #050505 100%);
            background-attachment: fixed;
            overflow-x: hidden;
        }
        .glass { 
            background: rgba(10, 10, 10, 0.85); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(160, 0, 96, 0.25); 
        }
        .hydra-gradient { 
            background: linear-gradient(135deg, #a00060 0%, #400020 100%); 
        }
        .hydra-glow {
            box-shadow: 0 0 25px rgba(160, 0, 96, 0.4);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #800045; border-radius: 10px; }
        
        .logo-img {
            object-fit: cover;
            filter: drop-shadow(0 0 15px rgba(160, 0, 96, 0.7));
            border: 2px solid rgba(160, 0, 96, 0.5);
            transition: transform 0.3s ease;
        }
        .logo-img:hover {
            transform: scale(1.05);
        }

        @keyframes pulse-energy {
            0% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
        }
        
        .energy-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(160, 0, 96, 0.15) 0%, transparent 75%);
            z-index: -1;
            animation: pulse-energy 6s infinite ease-in-out;
        }

        [v-cloak] { display: none; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div class="energy-bg"></div>
    <div id="app" v-cloak>
        <!-- TELA DE LOGIN -->
        <div v-if="!currentUser" class="min-h-screen flex items-center justify-center p-4">
            <div class="glass p-10 rounded-[2.5rem] w-full max-w-md border-magenta-500/20 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1.5 hydra-gradient shadow-[0_2px_10px_rgba(160,0,96,0.5)]"></div>
                <div class="flex flex-col items-center mb-10">
                    <div class="mb-6 relative">
                        <!-- Imagem em Base64 para garantir que NUNCA quebre -->
                        <img src="https://media.discordapp.net/attachments/1111490812069564436/1462884504803741839/image.png?ex=6970799d&is=696f281d&hm=74cf59715d4bfacc714f84212886159efa41072063f6c8d11422809d36327bea&=&format=webp&quality=lossless" alt="Hydra Logo" class="w-40 h-40 rounded-full logo-img shadow-2xl">
                    </div>
                    <h1 class="text-3xl font-black uppercase tracking-tighter text-white">Hydra <span class="text-[#ff0090] drop-shadow-[0_0_8px_rgba(255,0,144,0.5)]">Finances</span></h1>
                    <p class="text-[11px] text-zinc-500 uppercase font-black tracking-[0.3em] mt-2 opacity-60">Metrópole HQ • Acesso Restrito</p>
                </div>
                <form @submit.prevent="handleLogin" class="space-y-5">
                    <div class="relative group">
                        <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600 group-focus-within:text-[#ff0090] transition-colors"></i>
                        <input v-model="loginForm.username" type="text" placeholder="Operador" class="w-full bg-black/40 border border-zinc-800 rounded-2xl py-4 pl-12 pr-4 outline-none focus:border-[#a00060] focus:ring-1 focus:ring-[#a00060] transition-all text-white placeholder:text-zinc-700" required>
                    </div>
                    <div class="relative group">
                        <i class="fas fa-key absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600 group-focus-within:text-[#ff0090] transition-colors"></i>
                        <input v-model="loginForm.password" type="password" placeholder="Chave Mestra" class="w-full bg-black/40 border border-zinc-800 rounded-2xl py-4 pl-12 pr-4 outline-none focus:border-[#a00060] focus:ring-1 focus:ring-[#a00060] transition-all text-white placeholder:text-zinc-700" required>
                    </div>
                    <button class="w-full hydra-gradient py-4 rounded-2xl font-black uppercase tracking-[0.2em] text-sm hover:scale-[1.03] active:scale-[0.97] transition-all text-white shadow-xl hydra-glow mt-4">
                        Desbloquear Cofre
                    </button>
                </form>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div v-else class="min-h-screen p-4 md:p-8">
            <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                <div class="flex items-center gap-5">
                    <div class="relative">
                        <img src="https://media.discordapp.net/attachments/1111490812069564436/1462884504803741839/image.png?ex=6970799d&is=696f281d&hm=74cf59715d4bfacc714f84212886159efa41072063f6c8d11422809d36327bea&=&format=webp&quality=lossless" alt="Logo" class="w-16 h-16 rounded-full border-2 border-[#a00060]/40 logo-img">
                        <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-500 border-4 border-[#0a0a0a] rounded-full"></div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-black tracking-tighter uppercase text-white">Hydra <span class="text-[#ff0090]">Finances</span></h1>
                        <div class="flex items-center gap-3">
                            <span class="text-[11px] text-zinc-500 uppercase font-black tracking-widest">{{ currentUser.username }}</span>
                            <span :class="['text-[9px] px-2 py-0.5 rounded-full font-black border uppercase tracking-widest', currentUser.role === 'LIDER' ? 'bg-[#ff0090]/10 text-[#ff0090] border-[#ff0090]/30 shadow-[0_0_10px_rgba(255,0,144,0.2)]' : 'bg-zinc-800 text-zinc-400 border-transparent']">
                                {{ currentUser.role }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center items-center gap-3">
                    <div class="glass px-5 py-2.5 rounded-xl flex items-center gap-3 border-magenta-500/10 hover:border-magenta-500/30 transition-all cursor-pointer">
                        <i class="fas fa-calendar-day text-[#ff0090] text-sm"></i>
                        <input type="date" v-model="selectedDate" class="bg-transparent text-sm text-zinc-300 outline-none cursor-pointer font-bold">
                    </div>
                    
                    <template v-if="currentUser.role === 'LIDER'">
                        <button @click="toggleUserMgmt" :class="['flex items-center gap-2 px-5 py-2.5 glass rounded-xl transition-all text-xs font-black uppercase tracking-widest', showUserMgmt ? 'bg-[#a00060] text-white shadow-lg' : 'text-zinc-400 hover:text-white']">
                            <i class="fas fa-id-card"></i> Gestão
                        </button>
                        <button @click="toggleSettings" :class="['flex items-center gap-2 px-5 py-2.5 glass rounded-xl transition-all text-xs font-black uppercase tracking-widest', showSettings ? 'bg-[#a00060] text-white shadow-lg' : 'text-zinc-400 hover:text-white']">
                            <i class="fas fa-sliders text-[#ff0090]"></i> Configs
                        </button>
                    </template>

                    <button @click="handleLogout" class="flex items-center gap-2 px-5 py-2.5 glass rounded-xl text-red-500 hover:bg-red-500/10 transition-all text-xs font-black uppercase tracking-widest border-red-500/20">
                        <i class="fas fa-power-off"></i> Sair
                    </button>
                </div>
            </header>

            <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- COLUNA ESQUERDA: AÇÕES -->
                <div class="lg:col-span-4 space-y-6">
                    
                    <!-- GESTÃO DE USUÁRIOS -->
                    <div v-if="showUserMgmt && currentUser.role === 'LIDER'" class="glass p-7 rounded-3xl border-[#a00060]/30 shadow-2xl animate-in slide-in-from-left duration-300">
                        <h3 class="text-xs font-black mb-5 flex items-center gap-2 uppercase text-[#ff0090] tracking-[0.2em]">
                            <i class="fas fa-user-plus"></i> Novo Operador
                        </h3>
                        <form @submit.prevent="handleAddUser" class="space-y-4 mb-6">
                            <input v-model="newUser.username" type="text" placeholder="Nome" class="w-full bg-black/60 border border-zinc-800 rounded-xl p-3 text-sm outline-none focus:border-[#a00060] text-white" required>
                            <input v-model="newUser.password" type="password" placeholder="Senha" class="w-full bg-black/60 border border-zinc-800 rounded-xl p-3 text-sm outline-none focus:border-[#a00060] text-white" required>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" @click="newUser.role = 'GERENTE'" :class="['p-3 rounded-xl border text-[10px] font-black transition-all tracking-widest', newUser.role === 'GERENTE' ? 'bg-[#a00060] border-[#a00060] text-white' : 'bg-zinc-900 border-zinc-800 text-zinc-500']">GERENTE</button>
                                <button type="button" @click="newUser.role = 'LIDER'" :class="['p-3 rounded-xl border text-[10px] font-black transition-all tracking-widest', newUser.role === 'LIDER' ? 'bg-[#a00060] border-[#a00060] text-white' : 'bg-zinc-900 border-zinc-800 text-zinc-500']">LÍDER</button>
                            </div>
                            <button class="w-full hydra-gradient p-3.5 rounded-xl hover:opacity-90 transition-all text-white font-black text-xs uppercase tracking-[0.2em] shadow-lg">Registrar</button>
                        </form>
                        <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-1">
                            <div v-for="user in users" :key="user.id" class="flex justify-between items-center p-3 bg-white/5 rounded-xl text-xs border border-white/5 group">
                                <div><span class="font-bold text-white group-hover:text-[#ff0090] transition-colors">{{ user.username }}</span> <span class="text-[8px] opacity-40 uppercase ml-1 tracking-tighter">{{ user.role }}</span></div>
                                <button v-if="user.id !== 'admin-root' && user.id !== currentUser.id" @click="deleteUser(user.id)" class="text-zinc-600 hover:text-red-500 p-1"><i class="fas fa-trash-can"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- RESUMO FINANCEIRO -->
                    <div class="grid grid-cols-1 gap-4">
                        <div class="glass p-6 rounded-3xl border-l-[6px] border-l-[#a00060] shadow-2xl">
                            <p class="text-zinc-500 text-[10px] uppercase font-black tracking-[0.2em]">Total Lavado Hoy</p>
                            <h2 class="text-3xl font-black mt-1 text-white tabular-nums tracking-tighter">{{ formatMoney(dailyStats.dirty) }}</h2>
                        </div>
                        <div class="glass p-6 rounded-3xl border-l-[6px] border-l-[#ff0090] shadow-2xl bg-gradient-to-br from-[#1a0010] to-transparent">
                            <p class="text-[#ff0090]/70 text-[10px] uppercase font-black tracking-[0.2em]">Lucro Hydra</p>
                            <h2 class="text-3xl font-black mt-1 text-[#ff0090] tabular-nums tracking-tighter">{{ formatMoney(dailyStats.profit) }}</h2>
                        </div>
                    </div>

                    <!-- FORMULÁRIO DE LANÇAMENTO -->
                    <div :class="['glass p-8 rounded-[2rem] border-2 shadow-2xl transition-all duration-500', editingId ? 'border-[#ff0090]' : 'border-[#a00060]/10']">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="text-xl font-black flex items-center gap-3 uppercase tracking-tighter text-white">
                                <i :class="['fas', editingId ? 'fa-pen-to-square text-[#ff0090]' : 'fa-vault text-[#a00060]']"></i>
                                {{ editingId ? 'Editar' : 'Nova Lavagem' }}
                            </h3>
                            <button v-if="editingId" @click="cancelEdit" class="text-zinc-600 hover:text-white"><i class="fas fa-times-circle text-2xl"></i></button>
                        </div>
                        <form @submit.prevent="saveTransaction" class="space-y-5">
                            <div>
                                <label class="text-[10px] text-zinc-500 block mb-2 uppercase font-black tracking-[0.2em]">Org / Cliente</label>
                                <input v-model="form.family" type="text" placeholder="Nome da Org" class="w-full bg-black/60 border border-zinc-800 rounded-2xl p-4 focus:border-[#a00060] outline-none text-sm text-white font-bold" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-2 uppercase font-black tracking-[0.2em]">Sujo</label>
                                    <input v-model.number="form.dirtyAmount" type="number" placeholder="0" class="w-full bg-black/60 border border-zinc-800 rounded-2xl p-4 focus:border-[#a00060] outline-none text-sm text-white font-mono font-bold" required>
                                </div>
                                <div>
                                    <label class="text-[10px] text-zinc-500 block mb-2 uppercase font-black tracking-[0.2em]">Alvejantes</label>
                                    <input v-model.number="form.bleachCount" type="number" :placeholder="'Sugerido: ' + bleachSuggestion" class="w-full bg-black/60 border border-zinc-800 rounded-2xl p-4 focus:border-[#a00060] outline-none text-sm text-white font-mono font-bold" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button type="button" @click="form.category = 'Pista'" :class="['p-4 rounded-2xl border-2 text-[11px] font-black transition-all uppercase tracking-widest', form.category === 'Pista' ? 'bg-[#a00060] border-[#ff0090]/50 text-white shadow-lg' : 'bg-zinc-900/50 border-zinc-800 text-zinc-600']">PISTA ({{settings.taxPista}}%)</button>
                                <button type="button" @click="form.category = 'Produtos'" :class="['p-4 rounded-2xl border-2 text-[11px] font-black transition-all uppercase tracking-widest', form.category === 'Produtos' ? 'bg-[#a00060] border-[#ff0090]/50 text-white shadow-lg' : 'bg-zinc-900/50 border-zinc-800 text-zinc-600']">PRODS ({{settings.taxProdutos}}%)</button>
                            </div>
                            <button class="w-full font-black p-5 rounded-2xl transition-all shadow-xl flex items-center justify-center gap-3 text-white hydra-gradient hover:scale-[1.02] active:scale-[0.98] uppercase tracking-[0.2em] mt-2">
                                <i class="fas fa-check-double text-lg"></i>
                                {{ editingId ? 'Salvar Alteração' : 'Executar Lavagem' }}
                            </button>
                        </form>
                    </div>
                </div>

                <!-- COLUNA DIREITA: HISTÓRICO -->
                <div class="lg:col-span-8 space-y-5">
                    <div class="flex items-center justify-between mb-4 px-2">
                        <h3 class="text-2xl font-black flex items-center gap-3 uppercase text-white tracking-tighter">
                            <i class="fas fa-history text-[#ff0090]"></i> Histórico Recente
                        </h3>
                        <div class="bg-zinc-900/80 px-4 py-2 rounded-full border border-[#a00060]/20">
                            <span class="text-[10px] text-zinc-400 uppercase font-black tracking-[0.2em]">{{ dailyTransactions.length }} entradas</span>
                        </div>
                    </div>

                    <div class="space-y-4 max-h-[900px] overflow-y-auto pr-3 custom-scrollbar">
                        <div v-if="dailyTransactions.length === 0" class="glass p-24 rounded-[3rem] text-center border-dashed border-2 border-zinc-800/50">
                            <div class="w-20 h-20 bg-zinc-900/50 rounded-full flex items-center justify-center mx-auto mb-6 opacity-30">
                                <i class="fas fa-database text-4xl"></i>
                            </div>
                            <p class="text-zinc-600 font-black uppercase tracking-[0.3em] text-xs">Aguardando operações para esta data</p>
                        </div>
                        
                        <div v-for="t in dailyTransactions" :key="t.id" class="glass p-6 rounded-3xl flex flex-col md:grid md:grid-cols-6 items-center gap-6 border border-transparent hover:border-[#ff0090]/30 transition-all group relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1.5 h-full" :class="t.category === 'Pista' ? 'bg-orange-500' : 'bg-blue-500'"></div>
                            
                            <div class="col-span-2 w-full">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="font-black text-white text-xl truncate tracking-tighter">{{ t.family }}</span>
                                    <span :class="['text-[9px] px-2.5 py-1 rounded-md font-black uppercase tracking-widest', t.category === 'Pista' ? 'bg-orange-950/40 text-orange-400' : 'bg-blue-950/40 text-blue-400']">
                                        {{ t.category === 'Pista' ? 'PISTA' : 'PRODS' }}
                                    </span>
                                </div>
                                <div class="flex flex-col gap-1 text-[10px] text-zinc-500 font-bold uppercase tracking-widest">
                                    <span class="flex items-center gap-2"><i class="fas fa-user-secret text-[#ff0090]"></i> Por: {{ t.createdBy }}</span>
                                    <span class="opacity-40">{{ t.time }} • {{ t.bleachCount }} Alvejantes</span>
                                </div>
                            </div>
                            
                            <div class="w-full">
                                <p class="text-[9px] text-zinc-600 uppercase font-black tracking-widest mb-1">Sujo</p>
                                <p class="font-bold text-zinc-300 text-base tabular-nums">{{ formatMoney(t.dirtyAmount) }}</p>
                            </div>
                            
                            <div class="w-full">
                                <p class="text-[9px] text-[#ff0090] uppercase font-black tracking-widest mb-1">Devolução</p>
                                <p class="font-black text-white text-base tabular-nums">{{ formatMoney(t.returnedAmount) }}</p>
                            </div>
                            
                            <div class="w-full">
                                <p class="text-[9px] text-emerald-500 uppercase font-black tracking-widest mb-1">Lucro</p>
                                <p class="font-black text-emerald-400 text-base tabular-nums">+{{ formatMoney(t.profit) }}</p>
                            </div>
                            
                            <div class="w-full flex items-center justify-end gap-2">
                                <template v-if="currentUser.role === 'LIDER'">
                                    <button @click="editTransaction(t)" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-zinc-500 hover:text-[#ff0090] hover:bg-[#ff0090]/10 transition-all"><i class="fas fa-edit"></i></button>
                                    <button @click="deleteTransaction(t.id)" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-zinc-500 hover:text-red-500 hover:bg-red-500/10 transition-all"><i class="fas fa-trash-alt"></i></button>
                                </template>
                                <div v-else class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 opacity-10">
                                    <i class="fas fa-lock text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- MODAL DE CONFIGS -->
            <div v-if="showSettings" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-4">
                <div class="glass w-full max-w-lg p-8 rounded-[2.5rem] border-[#ff0090]/30 shadow-[0_0_50px_rgba(255,0,144,0.2)]">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-2xl font-black uppercase tracking-tighter text-white flex items-center gap-3">
                            <i class="fas fa-gears text-[#ff0090]"></i> Configurações Hydra
                        </h3>
                        <button @click="showSettings = false" class="text-zinc-500 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-zinc-500 block mb-2 uppercase font-black">Taxa Pista %</label>
                                <input type="number" v-model="settings.taxPista" class="w-full bg-black/60 border border-zinc-800 rounded-xl p-3 text-white font-bold outline-none focus:border-[#ff0090]">
                            </div>
                            <div>
                                <label class="text-[10px] text-zinc-500 block mb-2 uppercase font-black">Taxa Prods %</label>
                                <input type="number" v-model="settings.taxProdutos" class="w-full bg-black/60 border border-zinc-800 rounded-xl p-3 text-white font-bold outline-none focus:border-[#ff0090]">
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-zinc-500 block mb-2 uppercase font-black">Alvejante (R$)</label>
                                <input type="number" v-model="settings.bleachPrice" class="w-full bg-black/60 border border-zinc-800 rounded-xl p-3 text-white font-bold outline-none focus:border-[#ff0090]">
                            </div>
                            <div>
                                <label class="text-[10px] text-zinc-500 block mb-2 uppercase font-black">Máquina %</label>
                                <input type="number" v-model="settings.machineTaxRate" class="w-full bg-black/60 border border-zinc-800 rounded-xl p-3 text-white font-bold outline-none focus:border-[#ff0090]">
                            </div>
                        </div>
                    </div>
                    <button @click="showSettings = false" class="w-full hydra-gradient py-4 rounded-xl mt-8 font-black uppercase tracking-widest text-white shadow-lg">Salvar Alterações</button>
                </div>
            </div>

            <footer class="max-w-7xl mx-auto mt-16 py-12 border-t border-zinc-900/50 flex flex-wrap justify-center gap-16 opacity-40 grayscale hover:grayscale-0 transition-all duration-700">
                <div class="flex items-center gap-4 text-zinc-500 text-[11px] font-black uppercase tracking-[0.3em]"><i class="fas fa-bolt text-[#ff0090]"></i> MÁQUINA: {{settings.machineTaxRate}}%</div>
                <div class="flex items-center gap-4 text-zinc-500 text-[11px] font-black uppercase tracking-[0.3em]"><i class="fas fa-droplet text-[#ff0090]"></i> ALVEJANTE: {{ formatMoney(settings.bleachPrice) }}</div>
                <div class="flex items-center gap-4 text-[#ff0090] text-[11px] font-black uppercase tracking-[0.4em]"><i class="fas fa-dragon"></i> HYDRA CORE v11.0</div>
            </footer>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const currentUser = ref(null);
                const users = ref([]);
                const transactions = ref([]);
                const settings = reactive({
                    taxPista: 45,
                    taxProdutos: 40,
                    bleachPrice: 8000,
                    machineTaxRate: 30
                });

                const loginForm = reactive({ username: '', password: '' });
                const newUser = reactive({ username: '', password: '', role: 'GERENTE' });
                const form = reactive({ family: '', dirtyAmount: null, bleachCount: null, category: 'Pista' });

                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const showSettings = ref(false);
                const showUserMgmt = ref(false);
                const editingId = ref(null);

                onMounted(() => {
                    const saved = localStorage.getItem('hydra_v11_db');
                    if (saved) {
                        const data = JSON.parse(saved);
                        users.value = data.users || [];
                        transactions.value = data.transactions || [];
                        Object.assign(settings, data.settings);
                    } else {
                        users.value = [{ id: 'admin-root', username: 'admin', password: 'hydra123', role: 'LIDER' }];
                    }
                    const session = localStorage.getItem('hydra_session_v11');
                    if (session) currentUser.value = JSON.parse(session);
                });

                watch([users, transactions, settings], () => {
                    localStorage.setItem('hydra_v11_db', JSON.stringify({
                        users: users.value,
                        transactions: transactions.value,
                        settings: settings
                    }));
                }, { deep: true });

                const bleachSuggestion = computed(() => {
                    if (!form.dirtyAmount || form.dirtyAmount <= 0) return 0;
                    return Math.ceil((form.dirtyAmount / 1000000) * 5);
                });

                const dailyTransactions = computed(() => {
                    return transactions.value.filter(t => {
                        const d = new Date(t.timestamp).toISOString().split('T')[0];
                        return d === selectedDate.value;
                    }).sort((a,b) => b.timestamp - a.timestamp);
                });

                const dailyStats = computed(() => {
                    return dailyTransactions.value.reduce((acc, t) => ({
                        dirty: acc.dirty + t.dirtyAmount,
                        profit: acc.profit + t.profit
                    }), { dirty: 0, profit: 0 });
                });

                const handleLogin = () => {
                    const user = users.value.find(u => 
                        u.username.toLowerCase() === loginForm.username.toLowerCase() && 
                        u.password === loginForm.password
                    );
                    if (user) {
                        currentUser.value = user;
                        localStorage.setItem('hydra_session_v11', JSON.stringify(user));
                    } else alert('Cofre Bloqueado: Operador desconhecido.');
                };

                const handleLogout = () => {
                    currentUser.value = null;
                    localStorage.removeItem('hydra_session_v11');
                };

                const handleAddUser = () => {
                    if (users.value.find(u => u.username.toLowerCase() === newUser.username.toLowerCase())) {
                        return alert('Este codinome já está na organização.');
                    }
                    users.value.push({ id: Date.now().toString(), ...newUser });
                    newUser.username = ''; newUser.password = ''; newUser.role = 'GERENTE';
                };

                const deleteUser = (id) => {
                    if (confirm('Eliminar acesso deste operador?')) {
                        users.value = users.value.filter(u => u.id !== id);
                    }
                };

                const saveTransaction = () => {
                    const clientTax = form.category === 'Pista' ? settings.taxPista : settings.taxProdutos;
                    const returned = form.dirtyAmount * (1 - (clientTax / 100));
                    const machine = form.dirtyAmount * (settings.machineTaxRate / 100);
                    const cost = (form.bleachCount || 0) * settings.bleachPrice;
                    const prof = form.dirtyAmount - returned - machine - cost;

                    if (editingId.value) {
                        const idx = transactions.value.findIndex(t => t.id === editingId.value);
                        transactions.value[idx] = { 
                            ...transactions.value[idx], 
                            ...form, returnedAmount: returned, profit: prof, 
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
                        };
                        editingId.value = null;
                    } else {
                        transactions.value.push({
                            id: Date.now().toString(),
                            ...form,
                            returnedAmount: returned,
                            profit: prof,
                            timestamp: Date.now(),
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            createdBy: currentUser.value.username
                        });
                    }
                    form.family = ''; form.dirtyAmount = null; form.bleachCount = null;
                };

                const editTransaction = (t) => {
                    editingId.value = t.id;
                    Object.assign(form, { family: t.family, dirtyAmount: t.dirtyAmount, bleachCount: t.bleachCount, category: t.category });
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const deleteTransaction = (id) => {
                    if (confirm('Deletar registro permanentemente?')) {
                        transactions.value = transactions.value.filter(t => t.id !== id);
                    }
                };

                return {
                    currentUser, users, transactions, settings, loginForm, newUser, form,
                    selectedDate, showSettings, showUserMgmt, editingId, bleachSuggestion,
                    dailyTransactions, dailyStats, handleLogin, handleLogout, handleAddUser,
                    deleteUser, saveTransaction, editTransaction, deleteTransaction,
                    formatMoney: (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                    toggleUserMgmt: () => { showUserMgmt.value = !showUserMgmt.value; showSettings.value = false; },
                    toggleSettings: () => { showSettings.value = !showSettings.value; showUserMgmt.value = false; },
                    cancelEdit: () => { editingId.value = null; form.family = ''; form.dirtyAmount = null; form.bleachCount = null; }
                }
            }
        }).mount('#app');
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
